require "rake-pipeline-web-filters"
require File.expand_path("../lib/layout_filter", __FILE__)

output "public"

input "app" do
  # Javascripts
  match "javascripts/**/*.coffee" do
    coffee_script
  end

  match "javascripts/**/*.js" do
    minispade string: true, module_id_generator: lambda { |input| input.path.sub(%r{javascripts/}, "").sub(/\.js$/, "") }
    concat "application.js"
  end

  # Views
  match "views/*.haml" do
    tilt
    layout path: "app/layouts/application.haml"
    copy { |input| input.sub(%r{views/}, "").sub(/\.haml$/, ".html") }
  end

  # Stylesheets
  match "stylesheets/application.sass" do
    sass line_comments: false, additional_load_paths: "app/stylesheets/partials/"
    copy "application.css"
  end

  # Static files
  match "static/**/*" do
    copy { |input| input.sub(%r{static/}, "") }
  end
end
